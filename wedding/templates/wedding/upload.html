{% extends 'wedding/base.html' %}

{% block title %}Prześlij Zdjęcia - {{ block.super }}{% endblock %}

{% block extra_css %}
<style>
    .upload-drop-zone {
        border: 3px dashed #8b6f47;
        border-radius: 15px;
        padding: 40px 20px;
        text-align: center;
        background: linear-gradient(45deg, #f5f0e8 0%, #ede8dd 100%);
        min-height: 180px;
        position: relative;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .upload-drop-zone:hover {
        border-color: #5d4e37;
        background: linear-gradient(45deg, #ede8dd 0%, #e8dfd0 100%);
        transform: translateY(-2px);
    }
    
    .upload-drop-zone.dragover {
        border-color: #5d4e37;
        background: linear-gradient(45deg, #e8dfd0 0%, #ddd4c5 100%);
        transform: scale(1.02);
    }
    
    .upload-icon {
        font-size: 3.5rem;
        color: #8b6f47;
        margin-bottom: 15px;
    }
    
    .photo-preview-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 15px;
        margin-top: 20px;
    }
    
    .photo-preview-item {
        position: relative;
        border-radius: 10px;
        overflow: hidden;
        background: #f8f5f0;
        border: 1px solid #d4c4a8;
    }
    
    .photo-preview-img {
        width: 100%;
        height: 120px;
        object-fit: cover;
    }
    
    .photo-preview-name {
        padding: 8px;
        font-size: 0.8rem;
        color: #5d4e37;
        background: #f8f5f0;
        text-align: center;
        word-break: break-word;
    }
    
    .photo-remove-btn {
        position: absolute;
        top: 5px;
        right: 5px;
        background: rgba(220, 53, 69, 0.9);
        color: white;
        border: none;
        border-radius: 50%;
        width: 25px;
        height: 25px;
        font-size: 16px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .photo-remove-btn:hover {
        background: rgba(220, 53, 69, 1);
    }
    
    #upload-controls {
        display: none;
        text-align: center;
        margin-top: 20px;
    }
    
    .progress {
        height: 20px;
        background: #f8f5f0;
        border: 1px solid #d4c4a8;
        border-radius: 10px;
    }
    
    .progress-bar {
        background: linear-gradient(90deg, #8b6f47, #5d4e37);
        border-radius: 10px;
        transition: width 0.3s ease;
    }
    
    .file-count-badge {
        position: absolute;
        top: 10px;
        right: 10px;
        background: #8b6f47;
        color: white;
        padding: 5px 10px;
        border-radius: 15px;
        font-size: 0.8rem;
        font-weight: bold;
    }
    
    .selected-files-info {
        background: #e8f5e8;
        border: 1px solid #c3e6c3;
        border-radius: 10px;
        padding: 15px;
        margin-top: 15px;
        display: none;
    }
    
    @media (max-width: 768px) {
        .upload-drop-zone {
            padding: 30px 15px;
            min-height: 120px;
        }
        
        .upload-icon {
            font-size: 2.5rem;
        }
        
        .photo-preview-grid {
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
        }
        
        .photo-preview-img {
            height: 80px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <h2 class="section-title">📸 Prześlij Swoje Zdjęcia</h2>
    
    <div class="row justify-content-center">
        <div class="col-md-10">
            <!-- Główna informacja -->
            <div class="welcome-info mb-4" style="background: #f8f5f0; padding: 20px; border-radius: 10px; border: 1px solid #d4c4a8; text-align: center;">
                <h5 style="color: #5d4e37; margin-bottom: 15px;">
                    <i class="fas fa-images"></i> Prześlij wiele zdjęć naraz!
                </h5>
                <p style="color: #6b5b4f; margin-bottom: 10px;">
                    Wybierz wszystkie swoje najpiękniejsze zdjęcia z wesela i prześlij je jednym kliknięciem.
                </p>
                <p style="color: #6b5b4f; margin-bottom: 0; font-size: 0.9rem;">
                    <strong>Proste:</strong> Bez tytułów, bez opisów - po prostu wybierz zdjęcia i gotowe! ✨
                </p>
            </div>
            
            <!-- Formularz -->
            <form method="post" enctype="multipart/form-data" id="multi-upload-form">
                {% csrf_token %}
                
                <!-- Strefa drop & upload -->
                <div class="upload-drop-zone" id="drop-zone">
                    <div id="upload-prompt">
                        <div class="upload-icon">
                            <i class="fas fa-cloud-upload-alt"></i>
                        </div>
                        <h4 style="color: #5d4e37; margin-bottom: 10px;">Przeciągnij zdjęcia tutaj</h4>
                        <p style="color: #6b5b4f; margin-bottom: 15px;">lub kliknij aby wybrać z telefonu</p>
                        <button type="button" class="btn btn-custom-primary" id="select-files-btn">
                            <i class="fas fa-images"></i> Wybierz Zdjęcia
                        </button>
                    </div>
                    
                    <!-- Licznik plików -->
                    <div id="file-count" class="file-count-badge" style="display: none;">
                        0 zdjęć
                    </div>
                </div>
                
                <!-- Rzeczywiste pole pliku (będzie widoczne gdy wybrane) -->
                <input type="file" 
                       id="photo-files" 
                       name="photos" 
                       multiple 
                       accept="image/*,image/heic" 
                       style="display: none;">
                
                <!-- Info o wybranych plikach -->
                <div id="selected-files-info" class="selected-files-info">
                    <h6><i class="fas fa-check-circle text-success"></i> Wybrane zdjęcia:</h6>
                    <div id="file-list"></div>
                </div>
                
                <!-- Podgląd zdjęć -->
                <div id="photo-preview" class="photo-preview-grid"></div>
                
                <!-- Opcjonalne detale (domyślnie zwinięte) -->
                <div class="details-section mt-4" style="background: #f8f5f0; border-radius: 10px; border: 1px solid #d4c4a8;">
                    <button type="button" class="btn btn-link w-100 text-left" 
                            data-toggle="collapse" 
                            data-target="#optional-details" 
                            style="color: #5d4e37; text-decoration: none; padding: 15px;">
                        <i class="fas fa-chevron-right" id="details-chevron"></i>
                        <strong>Opcjonalnie: Dodaj swoje imię lub komentarz</strong>
                        <small class="text-muted d-block">Kliknij jeśli chcesz dodać detale</small>
                    </button>
                    
                    <div class="collapse" id="optional-details">
                        <div style="padding: 0 15px 15px;">
                            <div class="form-group">
                                <label>Twoje imię (opcjonalnie):</label>
                                <input type="text" name="uploader_name" class="form-control" placeholder="np. Anna i Tomek">
                            </div>
                            
                            <div class="form-group">
                                <label>Kategoria:</label>
                                <select name="category" class="form-control">
                                    <option value="party" selected>Zabawa</option>
                                    <option value="ceremony">Ceremonia</option>
                                    <option value="reception">Przyjęcie</option>
                                    <option value="family">Rodzina</option>
                                    <option value="friends">Przyjaciele</option>
                                    <option value="preparations">Przygotowania</option>
                                    <option value="other">Inne</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label>Komentarz do wszystkich zdjęć (opcjonalnie):</label>
                                <textarea name="description" class="form-control" rows="2" placeholder="np. Najlepsze momenty z parkietu! 💃🕺"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Przycisk wysyłania -->
                <div id="upload-controls">
                    <button type="submit" class="btn btn-custom-primary btn-lg btn-block" id="upload-button">
                        <i class="fas fa-cloud-upload-alt"></i> 
                        <span id="upload-button-text">Prześlij wszystkie zdjęcia</span>
                    </button>
                    
                    <!-- Progress bar -->
                    <div id="upload-progress" class="mt-3" style="display: none;">
                        <div class="progress">
                            <div class="progress-bar" role="progressbar" id="progress-bar" style="width: 0%"></div>
                        </div>
                        <div class="text-center mt-2">
                            <small id="progress-text">Przygotowuję zdjęcia...</small>
                            <span id="progress-percentage" class="badge badge-primary ml-2">0%</span>
                        </div>
                    </div>
                </div>
                
                <!-- Informacje techniczne -->
                <div class="mt-4" style="background: #e8f4fd; padding: 15px; border-radius: 10px; border: 1px solid #b8daff;">
                    <h6 style="color: #0056b3;">📋 Ważne informacje</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <ul class="small mb-0" style="color: #495057;">
                                <li><strong>Maksymalnie 10MB</strong> na jedno zdjęcie</li>
                                <li><strong>Formaty:</strong> JPG, PNG, HEIC</li>
                                <li><strong>Zdjęcia pojawią się</strong> po zatwierdzeniu</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <ul class="small mb-0" style="color: #495057;">
                                <li><strong>Możesz wysłać wiele</strong> zdjęć naraz</li>
                                <li><strong>Automatyczne tytuły</strong> z nazw plików</li>
                                <li><strong>Bezpieczne przechowywanie</strong> na serwerze</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('photo-files');
    const selectBtn = document.getElementById('select-files-btn');
    const photoPreview = document.getElementById('photo-preview');
    const uploadControls = document.getElementById('upload-controls');
    const fileCountBadge = document.getElementById('file-count');
    const selectedFilesInfo = document.getElementById('selected-files-info');
    const fileList = document.getElementById('file-list');
    const uploadForm = document.getElementById('multi-upload-form');
    
    // Przycisk wyboru plików
    selectBtn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        fileInput.click();
    });
    
    // Kliknięcie na strefę drop
    dropZone.addEventListener('click', function(e) {
        // Tylko gdy kliknięto bezpośrednio na strefę, nie na przycisk
        if (e.target === dropZone || e.target.closest('#upload-prompt')) {
            if (e.target !== selectBtn) {
                fileInput.click();
            }
        }
    });
    
    // Drag & Drop functionality
    dropZone.addEventListener('dragover', function(e) {
        e.preventDefault();
        e.stopPropagation();
        dropZone.classList.add('dragover');
    });
    
    dropZone.addEventListener('dragleave', function(e) {
        e.preventDefault();
        e.stopPropagation();
        dropZone.classList.remove('dragover');
    });
    
    dropZone.addEventListener('drop', function(e) {
        e.preventDefault();
        e.stopPropagation();
        dropZone.classList.remove('dragover');
        
        const files = Array.from(e.dataTransfer.files).filter(file => 
            file.type.startsWith('image/') || file.type === 'image/heic'
        );
        
        if (files.length > 0) {
            // Bezpośrednio ustawiamy pliki w input
            const dt = new DataTransfer();
            files.forEach(file => {
                if (file.size <= 10 * 1024 * 1024) { // 10MB limit
                    dt.items.add(file);
                } else {
                    alert(`⚠️ Plik "${file.name}" jest za duży (maksymalnie 10MB)`);
                }
            });
            fileInput.files = dt.files;
            handleFileSelection();
        }
    });
    
    // File input change - NAJWAŻNIEJSZE
    fileInput.addEventListener('change', function() {
        console.log('Files selected:', this.files.length);
        handleFileSelection();
    });
    
    function handleFileSelection() {
        const files = Array.from(fileInput.files);
        console.log('Handling files:', files.length);
        
        if (files.length === 0) {
            resetUI();
            return;
        }
        
        // Walidacja rozmiaru
        const validFiles = files.filter(file => {
            if (file.size > 10 * 1024 * 1024) {
                alert(`⚠️ Plik "${file.name}" jest za duży (maksymalnie 10MB)`);
                return false;
            }
            return true;
        });
        
        if (validFiles.length !== files.length) {
            // Przefiltruj pliki w input
            const dt = new DataTransfer();
            validFiles.forEach(file => dt.items.add(file));
            fileInput.files = dt.files;
        }
        
        updateUI(validFiles);
        showPreview(validFiles);
        showFileList(validFiles);
    }
    
    function updateUI(files) {
        const count = files.length;
        
        if (count > 0) {
            fileCountBadge.style.display = 'block';
            fileCountBadge.textContent = count === 1 ? '1 zdjęcie' : `${count} zdjęć`;
            
            uploadControls.style.display = 'block';
            selectedFilesInfo.style.display = 'block';
            
            // Ukryj prompt
            document.getElementById('upload-prompt').style.display = 'none';
            
            // Zmień tekst przycisku
            document.getElementById('upload-button-text').textContent = 
                count === 1 ? 'Prześlij 1 zdjęcie' : `Prześlij ${count} zdjęć`;
            
        } else {
            resetUI();
        }
    }
    
    function resetUI() {
        fileCountBadge.style.display = 'none';
        uploadControls.style.display = 'none';
        selectedFilesInfo.style.display = 'none';
        document.getElementById('upload-prompt').style.display = 'block';
        photoPreview.innerHTML = '';
        fileList.innerHTML = '';
    }
    
    function showFileList(files) {
        fileList.innerHTML = files.map((file, index) => `
            <div class="d-flex justify-content-between align-items-center mb-2 p-2" style="background: #f8f9fa; border-radius: 5px;">
                <span class="small">📷 ${file.name}</span>
                <div>
                    <span class="badge badge-info">${formatFileSize(file.size)}</span>
                    <button type="button" class="btn btn-sm btn-link text-danger p-0 ml-2" onclick="removeFileByIndex(${index})">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
        `).join('');
    }
    
    function showPreview(files) {
        photoPreview.innerHTML = '';
        
        // Pokazuj tylko pierwsze 6 zdjęć w podglądzie (oszczędność pamięci na mobile)
        files.slice(0, 6).forEach((file, index) => {
            const reader = new FileReader();
            reader.onload = function(e) {
                const previewItem = document.createElement('div');
                previewItem.className = 'photo-preview-item';
                previewItem.innerHTML = `
                    <img src="${e.target.result}" class="photo-preview-img" alt="Podgląd" loading="lazy">
                    <div class="photo-preview-name">${file.name}</div>
                    <button type="button" class="photo-remove-btn" onclick="removeFileByIndex(${index})" title="Usuń zdjęcie">×</button>
                `;
                photoPreview.appendChild(previewItem);
            };
            reader.readAsDataURL(file);
        });
        
        // Jeśli jest więcej niż 6 plików, pokaż informację
        if (files.length > 6) {
            const moreInfo = document.createElement('div');
            moreInfo.className = 'photo-preview-item d-flex align-items-center justify-content-center';
            moreInfo.style.background = '#f8f5f0';
            moreInfo.style.border = '2px dashed #8b6f47';
            moreInfo.innerHTML = `
                <div class="text-center" style="color: #5d4e37;">
                    <i class="fas fa-plus-circle fa-2x mb-2"></i>
                    <div class="small">+${files.length - 6} więcej zdjęć</div>
                </div>
            `;
            photoPreview.appendChild(moreInfo);
        }
    }
    
    // Globalna funkcja usuwania plików
    window.removeFileByIndex = function(index) {
        const files = Array.from(fileInput.files);
        files.splice(index, 1);
        
        // Odtwórz input files
        const dt = new DataTransfer();
        files.forEach(file => dt.items.add(file));
        fileInput.files = dt.files;
        
        handleFileSelection();
    };
    
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
    }
    
    // Obsługa wysyłania formularza
    uploadForm.addEventListener('submit', function(e) {
        const files = fileInput.files;
        console.log('Form submit with files:', files.length);
        
        if (!files || files.length === 0) {
            e.preventDefault();
            alert('⚠️ Proszę wybrać przynajmniej jedno zdjęcie!');
            return false;
        }
        
        // Sprawdź czy wszystkie pliki są obrazkami
        const validFiles = Array.from(files).filter(file => 
            file.type.startsWith('image/') || file.type === 'image/heic'
        );
        
        if (validFiles.length !== files.length) {
            e.preventDefault();
            alert('⚠️ Wszystkie pliki muszą być obrazkami!');
            return false;
        }
        
        // Pokaż progress
        document.getElementById('upload-progress').style.display = 'block';
        document.getElementById('upload-button').disabled = true;
        document.getElementById('upload-button').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Wysyłanie...';
        
        // Symulacja postępu
        simulateProgress(files.length);
    });
    
    function simulateProgress(fileCount) {
        let progress = 0;
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        const progressPercentage = document.getElementById('progress-percentage');
        
        const interval = setInterval(() => {
            progress += Math.random() * 10 + 5;
            if (progress > 90) progress = 90; // Nie dochodź do 100% przed końcem
            
            progressBar.style.width = progress + '%';
            progressPercentage.textContent = Math.round(progress) + '%';
            progressText.textContent = `Przesyłanie ${fileCount} zdjęć...`;
        }, 200);
        
        // Zatrzymaj symulację po 3 sekundach
        setTimeout(() => {
            clearInterval(interval);
            progressBar.style.width = '100%';
            progressPercentage.textContent = '100%';
            progressText.textContent = 'Finalizowanie...';
        }, 3000);
    }
    
    // Rozwijanie/zwijanie opcjonalnych detali
    const optionalDetails = document.getElementById('optional-details');
    const detailsChevron = document.getElementById('details-chevron');
    
    $('#optional-details').on('show.bs.collapse', function () {
        detailsChevron.style.transform = 'rotate(90deg)';
    });
    
    $('#optional-details').on('hide.bs.collapse', function () {
        detailsChevron.style.transform = 'rotate(0deg)';
    });
});
</script>
{% endblock %}